trigger:
  - master
  - develop
pr:
  branches:
    include:
      - "*"

stages:
    - stage: Test
      dependsOn: []
      jobs:
        - job: Test
          strategy:
            matrix:
                linux:
                    imageName: "ubuntu-latest"
                windows:
                    imageName: "windows-latest"
          pool:
            vmImage: $(imageName)
          steps:
              - task: DotNetCoreCLI@2
                displayName: Restore tools
                inputs:
                    command: "custom"
                    custom: "tool"
                    arguments: "restore"
              - task: DotNetCoreCLI@2
                displayName: Restore
                inputs:
                  command: 'restore'
              - task: DotNetCoreCLI@2
                displayName: Build
                inputs:
                  command: 'build'
                  arguments: '--configuration Release'
              - task: DotNetCoreCLI@2
                displayName: Run tests
                inputs:
                    command: "test"
                    arguments: "--configuration Release /p:AltCover=true /p:AltCoverForce=true"
              - task: DotNetCoreCLI@2
                displayName: Upload test coverage to codecov
                inputs:
                    command: "custom"
                    custom: "codecov"
                    arguments: '-t $(codecov_token) -f src/*/coverage.xml'
    - stage: Publish
      dependsOn: []
      jobs:
        - job: Publish
          pool:
            vmImage: windows-latest
          steps:
              - task: DotNetCoreCLI@2
                displayName: Dotnet publish
                inputs:
                  command: 'publish'
                  publishWebProjects: false
                  projects: 'src/ModSink.UI.Avalonia/ModSink.UI.Avalonia.csproj'
                  arguments: '-c Release -r win10-x64 --self-contained -o $(Build.ArtifactStagingDirectory)/ModSink.UI.Avalonia-win10-x64-sfc'
              - task: PublishBuildArtifacts@1
                displayName: Publish build artifacts
                inputs:
                    PathtoPublish: '$(Build.ArtifactStagingDirectory)/ModSink.UI.Avalonia-win10-x64-sfc/ModSink.UI.Avalonia.zip'
                    ArtifactName: 'ModSink.UI.Avalonia-win10-x64-sfc'
                    publishLocation: 'Container'
